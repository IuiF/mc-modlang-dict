# CLAUDE.md

必ず日本語で返答してください

## Project Overview

Minecraft Modの翻訳辞書とファイル構造パターンを管理するGoライブラリ。
高品質で一貫性のある日本語翻訳を実現する。

## 翻訳の基本原則

### 完全性優先（最重要）

**1つのModを100%翻訳してから次に進む。**

```
❌ NG: 6つのModを並列で60%ずつ翻訳
✅ OK: 1つのModを100%翻訳 → 次のModへ
```

### 翻訳作業の手順

1. **CurseForgeからModファイル（JAR）を取得**
   - 実際に翻訳対象となるModファイルを使用
   - JARを展開して`assets/[modid]/lang/en_us.json`を抽出
   - Patchouliは`data/[modid]/patchouli_books/`から抽出
   - 保存先: `workspace/imports/[mod_id]/`

2. **DBにインポート**
   - `moddict import` でJARからソースをDBに投入
   - 検出したテキストとパターンをDBに保存
   - キー数を正確に把握

3. **Haikuサブエージェントで翻訳**
   - DBからpendingを**20件ずつ**クエリ
   - **Haikuモデル**のサブエージェントで翻訳実行
   - **100件ごとにエージェントをリセット**（コンテキスト肥大化防止）
   - **並列実行可**（複数エージェントで同時処理）

4. **検証**
   - 翻訳率100%を確認
   - フォーマットコードの保持確認

5. **次のModへ**

### 翻訳エージェント実行パターン

```
┌─────────────────────────────────────────────────────────┐
│              DBから20件ずつクエリ                         │
└─────────────────────────────────────────────────────────┘
        │           │           │           │
        ▼           ▼           ▼           ▼
┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐
│ Haiku #1  │ │ Haiku #2  │ │ Haiku #3  │ │ Haiku #4  │
│ 1-20件    │ │ 21-40件   │ │ 41-60件   │ │ 61-80件   │
└───────────┘ └───────────┘ └───────────┘ └───────────┘
        │           │           │           │
        ▼           ▼           ▼           ▼
┌─────────────────────────────────────────────────────────┐
│              100件完了 → エージェントリセット              │
└─────────────────────────────────────────────────────────┘
```

**Haikuを使う理由**: 翻訳タスクは定型的で、コスト効率が良い。
**20件ずつの理由**: 適度なバッチサイズで品質を維持。
**100件リセットの理由**: コンテキスト肥大化によるパフォーマンス低下を防止。

### データ管理はDBで行う（重要）

```
❌ NG: YAML/JSONファイルで翻訳を管理 → 整合性の問題、重複、漏れ
✅ OK: SQLite DBで一元管理 → 正確なカウント、クエリ、検証が可能
```

**翻訳ワークフロー:**
1. ソースファイルを静的に取得（リポジトリクローン）
2. `moddict import` でソースをDBに投入（全キーが登録される）
3. `moddict translate -mod [mod_id] -export [file.json] -limit 1000` でpendingをエクスポート
4. Haikuサブエージェントで翻訳（JSON形式で出力）
5. **`moddict translate -mod [mod_id] -json [translated.json]` でDBにインポート（重要！）**
6. `moddict translate -mod [mod_id] -status` で進捗確認
7. `moddict export` で翻訳済みファイルを出力

**⚠️ 重要**: 翻訳結果をJSONファイルに保存しただけでは不十分。
必ず `-json` フラグでDBにインポートすること。

**DBスキーマ（既存）:**
- `mods` - Modメタデータ
- `mod_versions` - バージョン情報
- `translations` - 翻訳データ（key, source_text, target_text, status）
- `terms` - 用語辞書

### 禁止事項

- サンプル翻訳だけ作成して「完了」とすること
- 翻訳率60%で次のModに進むこと
- 主要エントリだけ翻訳して残りを放置すること

---

## 翻訳エージェント構成

### サブエージェント戦略

翻訳作業では**1Modずつ確実に完了**させる。並列実行は**同一Mod内のカテゴリ分割**に限定する。

### サブエージェントの役割

| エージェント | 役割 | 並列実行 |
|-------------|------|----------|
| 翻訳Agent | Mod単位・ファイル単位の翻訳実行 | 可 |
| 用語抽出Agent | 新規用語の抽出・辞書提案 | 可 |
| レビュアーAgent | 翻訳品質・一貫性の検証 | 最終段階 |
| 調査Agent | Mod構造・既存翻訳の調査 | 可 |

### 並列実行の原則

1. **Mod単位では順次実行**
   - 1つのModを100%完了してから次へ
   - 中途半端な状態で複数Modを並列しない

2. **同一Mod内のカテゴリは並列可**
   - block / item / advancement 等のカテゴリ分割
   - lang / patchouli の同時処理

3. **レビューは各Mod完了時に実施**
   - 翻訳率100%を確認
   - 用語の一貫性、フォーマット保持を検証

## 対象Mod（ATM9 Tier 1）

| Mod | Mod ID | キー数 | ステータス |
|-----|--------|--------|----------|
| Blood Magic | `bloodmagic` | 1,378 | 100%完了 |
| Create | `create` | 3,646 | 100%完了 |
| Botania | `botania` | 3,483 | 100%完了 |
| Mekanism | `mekanism` | 1,656 | 100%完了 |
| Tinkers' Construct | `tconstruct` | 2,875 | 100%完了 |
| Ars Nouveau | `ars_nouveau` | 1,529 | 100%完了 |

**合計: 14,567キー翻訳完了**

## 翻訳ガイドライン

### 用語の一貫性

```
global (低) → category (中) → mod (高)
```

### 必須ルール

1. **Minecraft公式訳に準拠** - バニラアイテム・ブロック名
2. **フォーマットコード保持** - `§`, `$(...)`, `%s`, `%d`
3. **改行・空白保持** - `\n`, `$(br)`, `$(br2)`

### Patchouliマクロ

- `$(br)` = 改行
- `$(br2)` = 空行
- `$(item)`, `$(thing)` = ハイライト
- `$(l:path)テキスト$(/)` = 内部リンク

## プロジェクト構造

```
data/
├── patterns/           # ファイルパターン定義
│   ├── default.yaml    # json_lang
│   ├── patchouli.yaml  # Patchouli
│   └── mantle_book.yaml # Mantle Book
└── terms/              # 用語辞書
    ├── global.yaml     # 共通用語
    ├── category/       # カテゴリ別
    └── mod/            # Mod固有
```

## 注意事項

- `workspace/imports/` のJARファイルはGitにコミットしない
- 翻訳データは `data/` ディレクトリにYAMLで管理
